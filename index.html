<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Pixel Paint with Supabase</title>
<style>
  html, body { margin: 0; height: 100%; font-family: sans-serif; }
  #container { display: flex; height: 100vh; }
  #sidebar { width: 80px; background: #eee; display: flex; flex-direction: column; align-items: center; padding: 10px; gap: 8px; }
  .color-option { width: 30px; height: 30px; border-radius: 4px; border: 2px solid #aaa; cursor: pointer; }
  #customColor { margin-top: 10px; width: 40px; height: 40px; border: 2px solid #aaa; cursor: pointer; }
  #canvasWrapper { flex: 1; background: #ccc; display: flex; justify-content: center; align-items: center; }
  canvas { image-rendering: pixelated; cursor: crosshair; background: white; border: 2px solid #333; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="container">
    <div id="sidebar">
      <div class="color-option" style="background:#ff0000" data-color="#ff0000"></div>
      <div class="color-option" style="background:#00ff00" data-color="#00ff00"></div>
      <div class="color-option" style="background:#0000ff" data-color="#0000ff"></div>
      <input type="color" id="customColor" title="Custom Color" />
    </div>
    <div id="canvasWrapper">
      <canvas id="pixelCanvas" width="500" height="500"></canvas>
    </div>
  </div>

<script>
  const canvas = document.getElementById('pixelCanvas');
  const ctx = canvas.getContext('2d');
  const gridSize = 50; // smaller grid for testing
  const pixelSize = canvas.width / gridSize;
  const cooldown = 10000;
  const localStorageKey = "lastPaintTime";
  let currentColor = "#000000";

  const supabaseUrl = "https://epucyhgtvvksxsjdqopz.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwdWN5aGd0dnZrc3hzamRxb3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MTcwNTQsImV4cCI6MjA2NjE5MzA1NH0.uKK7iIggeCVgRNHFEZV7_wIVMmZKbyGvZsgWqHzPoL8";
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  function drawPixel(x, y, color) {
    ctx.fillStyle = color;
    ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
    ctx.strokeStyle = "#ddd";
    ctx.lineWidth = 0.5;
    ctx.strokeRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
  }

  function drawGrid() {
    ctx.strokeStyle = "#ddd";
    ctx.lineWidth = 0.5;
    for (let x = 0; x <= gridSize; x++) {
      ctx.beginPath();
      ctx.moveTo(x * pixelSize, 0);
      ctx.lineTo(x * pixelSize, canvas.height);
      ctx.stroke();
    }
    for (let y = 0; y <= gridSize; y++) {
      ctx.beginPath();
      ctx.moveTo(0, y * pixelSize);
      ctx.lineTo(canvas.width, y * pixelSize);
      ctx.stroke();
    }
  }

  async function loadPixelsAndDraw() {
    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const { data, error } = await supabase.from('pixels').select('x, y, color');
    if (error) {
      console.error("Error loading pixels:", error);
      return;
    }
    if (data) {
      data.forEach(({ x, y, color }) => drawPixel(x, y, color));
    }
    drawGrid();
  }

  async function savePixel(x, y, color) {
    const { error } = await supabase.from('pixels').upsert({ x, y, color });
    if (error) console.error("Error saving pixel:", error);
  }

  canvas.addEventListener('click', async e => {
    const now = Date.now();
    const lastPaintTime = parseInt(localStorage.getItem(localStorageKey)) || 0;
    if (now - lastPaintTime < cooldown) {
      const waitTime = Math.ceil((cooldown - (now - lastPaintTime)) / 1000);
      alert(`Wait ${waitTime} more seconds before painting again.`);
      return;
    }

    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / pixelSize);
    const y = Math.floor((e.clientY - rect.top) / pixelSize);

    drawPixel(x, y, currentColor);
    await savePixel(x, y, currentColor);
    localStorage.setItem(localStorageKey, now);
  });

  const colorOptions = document.querySelectorAll('.color-option');
  const customColorPicker = document.getElementById('customColor');

  function setActiveColor(color, el = null) {
    currentColor = color;
    colorOptions.forEach(o => o.style.border = '2px solid #aaa');
    customColorPicker.style.border = '2px solid #aaa';
    if (el) el.style.border = '2px solid #000';
  }

  colorOptions.forEach(option => option.addEventListener('click', () => {
    setActiveColor(option.getAttribute('data-color'), option);
  }));

  customColorPicker.addEventListener('input', () => {
    setActiveColor(customColorPicker.value, customColorPicker);
  });

  setActiveColor('#ff0000', colorOptions[0]);
  loadPixelsAndDraw();
</script>
</body>
</html>
